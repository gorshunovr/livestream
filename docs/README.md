# Сервис live трансляции linkmeup

Сервис live трансляции linkmeup работает в виде двух виртуальных машин и
обеспечивает подключение гостей и ведущих к прямому эфиру с одной стороны,
и трансляцию прямого эфира в сеть слушателям с другой.

Серверы: **ts.linkmeup.ru** и **live.linkmeup.ru**.

## Содержание

- [Компоненты](#компоненты)
- [Работа сервиса](#работа-сервиса)
- [Работа оператора прямого эфира](#работа-оператора-прямого-эфира)
- [Возможные проблемы и их устранение](#возможные-проблемы-и-их-устранение)
- [Развёртывание и обновление сервисов](#развёртывание-и-обновление-сервисов)

## Компоненты

- Сервер **ts**

  1. Ubuntu 18.04
  1. TeamSpeak Server
  1. TeamSpeak Client
  1. Аудиоплеер Audacious
  1. DarkIce

  Для целей управления трансляцией так же установлен и запущен VNC сервис.

- Сервер **live**

  1. Ubuntu 18.04
  1. Icecast

## Работа сервиса

Ведущие и гости подключаются с помощью своих TeamSpeak клиентов к TeamSpeak
серверу *ts*, и могут свободно слышать друг друга.

На этом хосте так же запущен TeamSpeak клиент с пользователем **podbot** в том же
канале, где находятся и гости с ведущими. Пользователь **podbot** в своём клиенте
с отжатым динамиком слышит всё, что говорят в канале.

Аудиоплеер Audacious проигрывает джингл перед началом и в конце прямого эфира, а
так же играет фоновую музыку.

Весь проигрывающийся на хосте *ts* звук перехватывается DarkIce, кодируется в
mp3 и стримится в Icecast, запущенный на сервере *live*.

Сервис Icecast, запущенный на *live* получает поток от DarkIce, и раздаёт его
подключенным клиентам – слушателям прямого эфира выпуска подкаста linkmeup.

## Работа оператора прямого эфира

Оператор прямого эфира подключается к *ts* по SSH под своим пользователем и
пробрасывает себе порт VNC *5091*, например, с использованием такой конфигурации
в *~/.ssh/config*:

```text
Host ts.linkmeup.ru
    HostName ts.linkmeup.ru
    User <user>
    Port <port>
    IdentityFile ~/.ssh/id_linkmeup
    PreferredAuthentications publickey
    # UseKeychain yes    # OSX
    LocalForward 5901 localhost:5901
```

Оператор подключается VNC клиентом к *localhost:1*. Из меню Gnome 3 Activities
оператор запускает аудиоплеер Audacious, терминал Terminal, и (опционально)
Firefox. В терминале открываются две вкладки, в них запускаются DarkIce

```/home/linkmeup/Documents/linkmeup/start_darkice.sh```

и TeamSpeak клиент

```/home/linkmeup/Documents/linkmeup/start_teamspeak_client.sh```

В Audacious запускается играть плейлист фоновой музыки
*/home/linkmeup/Documents/linkmeup/live.m3u*. Весь звук немедленно уходит на
IceCast в прямой эфир.

> **Важно:** Прогрывание плейлиста должно быть по порядку, без shuffle.

В браузере можно открыть две вкладки: статус IceCast с *live*, и сам поток
прямого эфира, выключив ему звук.

> **Важно:** выключите звук в плеере прямого эфира в браузере, во избежание
  дублирования аудио и возникновения эхо.

В этот момент можно анонсировать скорое начало прямого эфира в Telegram каналах,
слушатели могут подключаться.

После запуска TeamSpeak клиента *podbot*'у отключается *динамик* и микрофон,
после чего он перемещается в канал *Beta*.

> **Важно:** отключите *podbot*'у динамик. Это предотвращает утечку разговоров,
  идущих до начала эфира, в, собственно, эфир.

В канале *Beta* собираются ведущие и гости. В прямой эфир в это время идёт
музыка, проигрываемая аудиоплеером.

В момент старта прямого эфира оператором выполняются следующие действия:

1. Подключается к прямому эфиру на *live* своим аудиоплеером (браузером)
1. Включает *podbot*'а режим многоканальной записи:
   *Tools -> Start Multitrack Recording*
1. Предупреждает в TeamSpeak ведущих и гостей о старте прямого эфира;
   гости и ведущие должны соблюдать тишину
1. Даблкликом на первом треке плейлиста запускает проигрывание джингла
1. После джингла по плейлисту играется тихая фоновая музыка
1. Отжимает (включает) динамик *podbot*'а; с этого момента ведущий начинает
   вести прямой эфир
1. Оператор прямого эфира выравнивает громкость участников путём регулировки их
   индивидуальной громкости в TeamSpeak, и регулирует громкость фоновой музыки
   ползунком в аудиоплеере; контроллирует громкость прослушивая прямой эфир с
   *live* Icecast'а в своём аудиоплеере (браузере)

В процессе прямого эфира оператор продолжает следить за трансляцией.

При окончании выпуска оператор прямого эфира выполняет следуюшие действия:

1. Нажимает (отключает) динамик *podbot*'а
1. Даблкликом на первом треке плейлиста запускает проигрывание джингла
1. Нажатием Ctrl-c в вкладке терминала останавливает DarkIce
1. Отключает *podbot*'у режим многоканальной записи:
   *Tools -> Stop Multitrack Recording*

## Возможные проблемы и их устранение

Если соединение с VNC сервисом установить не удаётся, то можно его перезапустить:

```shell
$ sudo -i
# su - linkmeup -c '/home/linkmeup/Documents/linkmeup/start_tigervnc.sh'
# Ctrl-d
$
```

## Развёртывание и обновление сервисов

Развёртывание и обновление сервисов на виртуальные машины производится запуском
Ansible [плейбука](../playbook.yaml) `playbook.yaml` с набором параметров.
Смотрите плейбук для информации о его работе.

Плейбук поддерживает обновление TeamSpeak сервера и клиента, при указании в
параметрах версий компонентов и их `sha256` сумм, публикуемых на сайте TeamSpeak.
Старые версии сервера и клиента сохраняются, не удаляются, для возможности
ручного отката изменений в случае экстренной необходимости.
